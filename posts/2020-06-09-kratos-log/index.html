<!DOCTYPE html>
<html lang="zh" dir="auto" data-theme="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Bilibili Kratos 框架源码分析(4) -- Kratos Log | HHFCodeRv</title>
<meta name="keywords" content="golang, kratos">
<meta name="description" content="用法

  
      
          flag
          env
          type
          remark
      
  
  
      
          log.v
          LOG_V
          int
          日志级别：DEBUG:0 INFO:1 WARN:2 ERROR:3 FATAL:4
      
      
          log.stdout
          LOG_STDOUT
          bool
          是否标准输出：true、false
      
      
          log.dir
          LOG_DIR
          string
          日志文件目录，如果配置会输出日志到文件，否则不输出日志文件
      
      
          log.module
          LOG_MODULE
          string
          可单独配置每个文件的verbose级别：file=1,file2=2
      
      
          log.filter
          LOG_FILTER
          string
          过虑敏感信息 format: field1,field2.
      
  

被阉割的功能: log.agent
配置文件
[log]
	family = &#34;xxx-service&#34;
	dir = &#34;/data/log/xxx-service/&#34;
	stdout = true
	v = 3
	filter = [&#34;fileld1&#34;, &#34;field2&#34;]
[log.module]
	&#34;dao_user&#34; = 2
	&#34;servic*&#34; = 1
对应的加载方法">
<meta name="author" content="haohongfan">
<link rel="canonical" href="https://georgehao.github.io/posts/2020-06-09-kratos-log/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://georgehao.github.io/images/icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://georgehao.github.io/images/icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://georgehao.github.io/images/icon.png">
<link rel="apple-touch-icon" href="https://georgehao.github.io/images/icon.png">
<link rel="mask-icon" href="https://georgehao.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://georgehao.github.io/posts/2020-06-09-kratos-log/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="https://georgehao.github.io/posts/2020-06-09-kratos-log/">
  <meta property="og:site_name" content="HHFCodeRv">
  <meta property="og:title" content="Bilibili Kratos 框架源码分析(4) -- Kratos Log">
  <meta property="og:description" content="用法 flag env type remark log.v LOG_V int 日志级别：DEBUG:0 INFO:1 WARN:2 ERROR:3 FATAL:4 log.stdout LOG_STDOUT bool 是否标准输出：true、false log.dir LOG_DIR string 日志文件目录，如果配置会输出日志到文件，否则不输出日志文件 log.module LOG_MODULE string 可单独配置每个文件的verbose级别：file=1,file2=2 log.filter LOG_FILTER string 过虑敏感信息 format: field1,field2. 被阉割的功能: log.agent
配置文件 [log] family = &#34;xxx-service&#34; dir = &#34;/data/log/xxx-service/&#34; stdout = true v = 3 filter = [&#34;fileld1&#34;, &#34;field2&#34;] [log.module] &#34;dao_user&#34; = 2 &#34;servic*&#34; = 1 对应的加载方法">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-06-09T10:14:07+08:00">
    <meta property="article:modified_time" content="2020-06-09T10:14:07+08:00">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="Kratos">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bilibili Kratos 框架源码分析(4) -- Kratos Log">
<meta name="twitter:description" content="用法

  
      
          flag
          env
          type
          remark
      
  
  
      
          log.v
          LOG_V
          int
          日志级别：DEBUG:0 INFO:1 WARN:2 ERROR:3 FATAL:4
      
      
          log.stdout
          LOG_STDOUT
          bool
          是否标准输出：true、false
      
      
          log.dir
          LOG_DIR
          string
          日志文件目录，如果配置会输出日志到文件，否则不输出日志文件
      
      
          log.module
          LOG_MODULE
          string
          可单独配置每个文件的verbose级别：file=1,file2=2
      
      
          log.filter
          LOG_FILTER
          string
          过虑敏感信息 format: field1,field2.
      
  

被阉割的功能: log.agent
配置文件
[log]
	family = &#34;xxx-service&#34;
	dir = &#34;/data/log/xxx-service/&#34;
	stdout = true
	v = 3
	filter = [&#34;fileld1&#34;, &#34;field2&#34;]
[log.module]
	&#34;dao_user&#34; = 2
	&#34;servic*&#34; = 1
对应的加载方法">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://georgehao.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Bilibili Kratos 框架源码分析(4) -- Kratos Log",
      "item": "https://georgehao.github.io/posts/2020-06-09-kratos-log/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Bilibili Kratos 框架源码分析(4) -- Kratos Log",
  "name": "Bilibili Kratos 框架源码分析(4) -- Kratos Log",
  "description": "用法 flag env type remark log.v LOG_V int 日志级别：DEBUG:0 INFO:1 WARN:2 ERROR:3 FATAL:4 log.stdout LOG_STDOUT bool 是否标准输出：true、false log.dir LOG_DIR string 日志文件目录，如果配置会输出日志到文件，否则不输出日志文件 log.module LOG_MODULE string 可单独配置每个文件的verbose级别：file=1,file2=2 log.filter LOG_FILTER string 过虑敏感信息 format: field1,field2. 被阉割的功能: log.agent\n配置文件 [log] family = \u0026#34;xxx-service\u0026#34; dir = \u0026#34;/data/log/xxx-service/\u0026#34; stdout = true v = 3 filter = [\u0026#34;fileld1\u0026#34;, \u0026#34;field2\u0026#34;] [log.module] \u0026#34;dao_user\u0026#34; = 2 \u0026#34;servic*\u0026#34; = 1 对应的加载方法\n",
  "keywords": [
    "golang", "kratos"
  ],
  "articleBody": "用法 flag env type remark log.v LOG_V int 日志级别：DEBUG:0 INFO:1 WARN:2 ERROR:3 FATAL:4 log.stdout LOG_STDOUT bool 是否标准输出：true、false log.dir LOG_DIR string 日志文件目录，如果配置会输出日志到文件，否则不输出日志文件 log.module LOG_MODULE string 可单独配置每个文件的verbose级别：file=1,file2=2 log.filter LOG_FILTER string 过虑敏感信息 format: field1,field2. 被阉割的功能: log.agent\n配置文件 [log] family = \"xxx-service\" dir = \"/data/log/xxx-service/\" stdout = true v = 3 filter = [\"fileld1\", \"field2\"] [log.module] \"dao_user\" = 2 \"servic*\" = 1 对应的加载方法\n// cmd/main.go func main() { paladin.Init() var cfg struct { Log *log.Config } if err := paladin.Get(\"application.toml\").UnmarshalTOML(\u0026cfg); err != nil { return } // init log log.Init(cfg.Log) // debug flag: log.dir={path} defer log.Close() } 最简单用法 Kratos Log 有 4 种级别的打印方式: log.Info(), log.Warn(), log.Error(), 以及一个log.V(4).Info(). 如果开启文件打印后, 会分别对应info.log, warn.log, error.log\nfunc main() { flag.Parse() log.Init(nil) log.Info(\"hi:%s\", \"kratos\") log.Infoc(Context.TODO(), \"hi:%s\", \"kratos\") log.Infov(Context.TODO(), log.KVInt(\"key1\", 100), log.KVString(\"key2\", \"test value\") // Warn, Error 这里就不写了, 跟 Info() 一样 log.V(5).Info(\"xxxx\") } log.v kratos log 日志级别(level)跟其他我们熟知的日志框架(logrus, zap)不太一样.\n以 logrus 为例:\npackage main import ( log \"github.com/sirupsen/logrus\" ) func main() { log.SetLevel(log.WarnLevel) log.WithFields(log.Fields{ \"animal\": \"walrus\", \"size\": 10, }).Info(\"A group of walrus emerges from the ocean\") } 当 SetLevel 后只会打印这个 Level 高的日志. 但是 Kraots 使用 log.Info(), log.Warn(), log.Error() 却没有这个功能. 也就是说只要程序里面使用就会输出.\n当然 Kratos 也提供了类似 logrus 的这种对应用法, 但是感觉有点另类. 需要配置文件设置log.v 配合 log.V(4).Info()使用. 如:\nlog.V(5).Info(\"xxx\") 如果 log.v 设置是 5, 那么能打印xxx. 如果 log.v 小于 5, 则不能打印. 也就是说 log.V 只能打印比 log.v 小的日志\nlog.module 这个功能我觉得没啥用处. 具体的功能就是:\n配置文件 log.v 设置是 3. 按照上面说的, log.V(5).Info(“xx”) 是肯定打印不出来的. 但是可以通过 log.module 来另外定义某些文件特殊打印级别\n[log] v = 3 [log.module] \"dao_user\" = 5 \"servic*\" = 1 在 dao_user.go 里面, log.V(5).Info(“dao_user”), 日志照样会打印 “dao_user”. dao_user, servic*是对应的文件的名字\nlog.stdout 这个简单, 就是控制日志是否打印在命令行里面. 生产环境需要关闭改选项(默认关闭), 在开发时打开这个是很有用的\nlog.dir 设置写日志文件的路径\nlog.filter 这个还是蛮有意思的功能. 比如打印日志的时候, 密码等敏感信息一般是不能打印在日志文件里. 该功能就能将这些信息隐藏掉\n[log] filter = [\"password\"] log.Infov(context.Background(), log.KV(\"password\", \"123456\")) 打印出来就会变成[2020/06/08 23:19:55.490] [INFO] [/demo1/cmd/main.go:21] password=***\n整体上 kratos log 就提供了这么多功能, 下面进入源码分析\n源码分析 加载 Init 其实加载没啥说的, 主要就是调用Init()函数\nfunc Init(conf *Config) { var isNil bool if conf == nil { isNil = true conf = \u0026Config{ Stdout: _stdout, Dir: _dir, V: int32(_v), Module: _module, Filter: _filter, } } if len(env.AppID) != 0 { conf.Family = env.AppID // for caster } conf.Host = env.Hostname if len(conf.Host) == 0 { host, _ := os.Hostname() conf.Host = host } var hs []Handler // when env is dev if conf.Stdout || (isNil \u0026\u0026 (env.DeployEnv == \"\" || env.DeployEnv == env.DeployEnvDev)) || _noagent { hs = append(hs, NewStdout()) } if conf.Dir != \"\" { hs = append(hs, NewFile(conf.Dir, conf.FileBufferSize, conf.RotateSize, conf.MaxLogFile)) } h = newHandlers(conf.Filter, hs...) c = conf } 作用:\n初始化文章一开头提到那五个功能: log.v, log.stdout, log.dir, log.module, log.filter 初始化 stdout, file handler Field 基于zap的field方式实现的高性能log库，提供Info、Warn、Error日志级别； 并提供了context支持，方便打印环境信息以及日志的链路追踪，在框架中都通过field方式实现，避免format日志带来的性能消耗\n上面这段摘自官方wiki, 但是看完源码之后, 发现跟 zap 毛线关系没有, 就用了 zap 的一个结构体\ntype Field struct { Key string Value interface{} Type FieldType StringVal string Int64Val int64 } 其实想不太明白, 就用了一个结构体(也没有用任何 zap 为该结构体提供的函数), 为何将 zap 那么多代码复制了过来, 差评\nKartos log 没有采用类似 logrus 或者 Zap json 或者 text 序列化的方案, 就以上面的 Field 为基础扩展一个 KVString, KVInt, …. KVDuration 结构. 在写日志时候, 我们就可以像下面这样打印多个kv\nlog.Infov(Context.TODO(), log.KVInt(\"key1\", 100), log.KVString(\"key2\", \"test value\") Handler 上面的log.InfoV(xxx) 将会调用下面的 Log() 函数\nfunc (hs Handlers) Log(ctx context.Context, lv Level, d ...D) { hasSource := false for i := range d { if _, ok := hs.filters[d[i].Key]; ok { d[i].Value = \"***\" // 实现log.filter } if d[i].Key == _source { hasSource = true } } if !hasSource { fn := funcName(3) errIncr(lv, fn) d = append(d, KVString(_source, fn)) } d = append(d, KV(_time, time.Now()), KVInt64(_levelValue, int64(lv)), KVString(_level, lv.String())) for _, h := range hs.handlers { h.Log(ctx, lv, d...) } } Kratos log 提供的所有Info(), Warn(), Error() 系列函数最终都会调用到这个函数上面来.\n这个函数的主要作用就是:\n实现 log.filter 功能 增加一些额外的字段, 如: time, level, source Field 根据初始化 log 的时候是否启动 stdout 或者 file handler, 来调用对应的handler 的 Log 函数做最终处理 handlers (stdout, file) 上面的Handler Log() 里面有这么句代码. 就是具体调用 stdout或者file handlers\nfor _, h := range hs.handlers { h.Log(ctx, lv, d...) } 不过在调用具体的 handler 来打印的时候, 需要对相关的 Field 来做处理, 分别会调用下面 toMap, addExtraField 函数, 将处理结果都放在一个 map[string]interface{}里\ntoMap func toMap(args ...D) map[string]interface{} { d := make(map[string]interface{}, 10+len(args)) for _, arg := range args { switch arg.Type { case core.UintType, core.Uint64Type, core.IntTpye, core.Int64Type: d[arg.Key] = arg.Int64Val case core.StringType: d[arg.Key] = arg.StringVal case core.Float32Type: d[arg.Key] = math.Float32frombits(uint32(arg.Int64Val)) case core.Float64Type: d[arg.Key] = math.Float64frombits(uint64(arg.Int64Val)) case core.DurationType: d[arg.Key] = time.Duration(arg.Int64Val) default: d[arg.Key] = arg.Value } } return d } 其实这段代码没啥意思, 就是将 KVInt(), KVString()系列函数对应的Val从对应的字段上取出来\naddExtraField func addExtraField(ctx context.Context, fields map[string]interface{}) { if t, ok := trace.FromContext(ctx); ok { fields[_tid] = t.TraceID() } if caller := metadata.String(ctx, metadata.Caller); caller != \"\" { fields[_caller] = caller } if color := metadata.String(ctx, metadata.Color); color != \"\" { fields[_color] = color } if env.Color != \"\" { fields[_envColor] = env.Color } if cluster := metadata.String(ctx, metadata.Cluster); cluster != \"\" { fields[_cluster] = cluster } fields[_deplyEnv] = env.DeployEnv fields[_zone] = env.Zone fields[_appID] = c.Family fields[_instanceID] = c.Host if metadata.String(ctx, metadata.Mirror) != \"\" { fields[_mirror] = true } } 这段代码就是另外再加几个字段, 如果 env, zone, appid, instance_id, caller, tid\nPattern 经过上面的操作基本上操作, map[string]interface{} 里面大概有这些内容\ntest1 -\u003e test1 source -\u003e /learn_kratos/demo1/cmd/main.go:21 time -\u003e 2020-06-09T19:07:36.3063 level_value -\u003e 1 level -\u003e INFO app_id -\u003e xxx-service instance_id -\u003e localhost env -\u003e dev zone -\u003e zone01 接着要做的就是将他们写成字符串(对, kratos 只提供了TextFormater方式)\nvar patternMap = map[string]func(map[string]interface{}) string{ \"T\": longTime, \"t\": shortTime, \"D\": longDate, \"d\": shortDate, \"L\": keyFactory(_level), \"f\": keyFactory(_source), \"i\": keyFactory(_instanceID), \"e\": keyFactory(_deplyEnv), \"z\": keyFactory(_zone), \"S\": longSource, \"s\": shortSource, \"M\": message, } .... for _, f := range p.funcs { builder.WriteString(f(d)) } 这里的实现方式还是蛮巧妙的, 可以看看\nstdout, filewriter 经过上面的处理, 就进入了最后的输出阶段了, 分别对应 stdout, filewirter\n鉴于篇幅有限, filewriter 本篇就不再介绍, 另外再出一篇吧\n总结 优点: kratos log整体采用 Kv 结构来处理, 结构比较清晰, 功能简单, 没有序列化的压力, 追踪日志需要的字段全都有.\n缺点: 只支持TextFormater, 日志级别控制跟当前主流 Log 框架使用习惯不太一样\n",
  "wordCount" : "2136",
  "inLanguage": "zh",
  "datePublished": "2020-06-09T10:14:07+08:00",
  "dateModified": "2020-06-09T10:14:07+08:00",
  "author":{
    "@type": "Person",
    "name": "haohongfan"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://georgehao.github.io/posts/2020-06-09-kratos-log/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "HHFCodeRv",
    "logo": {
      "@type": "ImageObject",
      "url": "https://georgehao.github.io/images/icon.png"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://georgehao.github.io/" accesskey="h" title="HHFCodeRv (Alt + H)">
                <img src="https://georgehao.github.io/images/icon.png" alt="" aria-label="logo"
                    height="35">HHFCodeRv</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://georgehao.github.io/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="https://gohandbook1.haohongfan.com" title="Go 源码分析与实战">
                    <span>Go 源码分析与实战</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://georgehao.github.io/archive/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://georgehao.github.io/friends/friends/" title="好友推荐">
                    <span>好友推荐</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://georgehao.github.io/">主页</a>&nbsp;»&nbsp;<a href="https://georgehao.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Bilibili Kratos 框架源码分析(4) -- Kratos Log
    </h1>
    <div class="post-meta"><span title='2020-06-09 10:14:07 +0800 CST'>2020年6月9日</span>&nbsp;·&nbsp;<span>5 分钟</span>&nbsp;·&nbsp;<span>2136 字</span>&nbsp;·&nbsp;<span>haohongfan</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#用法">用法</a></li>
    <li><a href="#配置文件">配置文件</a>
      <ul>
        <li><a href="#最简单用法">最简单用法</a></li>
        <li><a href="#logv">log.v</a>
          <ul>
            <li><a href="#logmodule">log.module</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#logstdout">log.stdout</a></li>
    <li><a href="#logdir">log.dir</a></li>
    <li><a href="#logfilter">log.filter</a></li>
    <li><a href="#源码分析">源码分析</a>
      <ul>
        <li><a href="#加载-init">加载 Init</a></li>
        <li><a href="#field">Field</a></li>
        <li><a href="#handler">Handler</a></li>
        <li><a href="#handlers-stdout-file">handlers (stdout, file)</a>
          <ul>
            <li><a href="#tomap">toMap</a></li>
            <li><a href="#addextrafield">addExtraField</a></li>
          </ul>
        </li>
        <li><a href="#pattern">Pattern</a></li>
        <li><a href="#stdout-filewriter">stdout, filewriter</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="用法">用法<a hidden class="anchor" aria-hidden="true" href="#用法">#</a></h2>
<table>
  <thead>
      <tr>
          <th style="text-align: left">flag</th>
          <th style="text-align: left">env</th>
          <th style="text-align: left">type</th>
          <th style="text-align: left">remark</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">log.v</td>
          <td style="text-align: left">LOG_V</td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">日志级别：DEBUG:0 INFO:1 WARN:2 ERROR:3 FATAL:4</td>
      </tr>
      <tr>
          <td style="text-align: left">log.stdout</td>
          <td style="text-align: left">LOG_STDOUT</td>
          <td style="text-align: left">bool</td>
          <td style="text-align: left">是否标准输出：true、false</td>
      </tr>
      <tr>
          <td style="text-align: left">log.dir</td>
          <td style="text-align: left">LOG_DIR</td>
          <td style="text-align: left">string</td>
          <td style="text-align: left">日志文件目录，如果配置会输出日志到文件，否则不输出日志文件</td>
      </tr>
      <tr>
          <td style="text-align: left">log.module</td>
          <td style="text-align: left">LOG_MODULE</td>
          <td style="text-align: left">string</td>
          <td style="text-align: left">可单独配置每个文件的verbose级别：file=1,file2=2</td>
      </tr>
      <tr>
          <td style="text-align: left">log.filter</td>
          <td style="text-align: left">LOG_FILTER</td>
          <td style="text-align: left">string</td>
          <td style="text-align: left">过虑敏感信息 format: field1,field2.</td>
      </tr>
  </tbody>
</table>
<p>被阉割的功能: log.agent</p>
<h2 id="配置文件">配置文件<a hidden class="anchor" aria-hidden="true" href="#配置文件">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">log</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nx">family</span> <span class="p">=</span> <span class="s2">&#34;xxx-service&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dir</span> <span class="p">=</span> <span class="s2">&#34;/data/log/xxx-service/&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">stdout</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="nx">v</span> <span class="p">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">	<span class="nx">filter</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;fileld1&#34;</span><span class="p">,</span> <span class="s2">&#34;field2&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">log</span><span class="p">.</span><span class="nx">module</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;dao_user&#34;</span> <span class="p">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;servic*&#34;</span> <span class="p">=</span> <span class="mi">1</span>
</span></span></code></pre></div><p>对应的加载方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// cmd/main.go</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">paladin</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">var</span><span class="w"> </span><span class="nx">cfg</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">Log</span><span class="w"> </span><span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">paladin</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;application.toml&#34;</span><span class="p">).</span><span class="nf">UnmarshalTOML</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">// init log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">log</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Log</span><span class="p">)</span><span class="w"> </span><span class="c1">// debug flag: log.dir={path}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">defer</span><span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="最简单用法">最简单用法<a hidden class="anchor" aria-hidden="true" href="#最简单用法">#</a></h3>
<p>Kratos Log 有 4 种级别的打印方式: log.Info(), log.Warn(), log.Error(), 以及一个log.V(4).Info(). 如果开启文件打印后, 会分别对应info.log, warn.log, error.log</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;hi:%s&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;kratos&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nf">Infoc</span><span class="p">(</span><span class="nx">Context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;hi:%s&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;kratos&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nf">Infov</span><span class="p">(</span><span class="nx">Context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nf">KVInt</span><span class="p">(</span><span class="s">&#34;key1&#34;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">),</span><span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nf">KVString</span><span class="p">(</span><span class="s">&#34;key2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;test value&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Warn, Error 这里就不写了, 跟 Info() 一样</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;xxxx&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="logv">log.v<a hidden class="anchor" aria-hidden="true" href="#logv">#</a></h3>
<p>kratos log 日志级别(level)跟其他我们熟知的日志框架(logrus, zap)不太一样.</p>
<p>以 logrus 为例:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nx">log</span><span class="w"> </span><span class="s">&#34;github.com/sirupsen/logrus&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">log</span><span class="p">.</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">WarnLevel</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="nx">log</span><span class="p">.</span><span class="nf">WithFields</span><span class="p">(</span><span class="nx">log</span><span class="p">.</span><span class="nx">Fields</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="s">&#34;animal&#34;</span><span class="p">:</span><span class="w"> </span><span class="s">&#34;walrus&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="s">&#34;size&#34;</span><span class="p">:</span><span class="w">   </span><span class="mi">10</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;A group of walrus emerges from the ocean&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>当 <code>SetLevel</code> 后只会打印这个 Level 高的日志. 但是 Kraots 使用 log.Info(), log.Warn(), log.Error() 却没有这个功能. 也就是说只要程序里面使用就会输出.</p>
<p>当然 Kratos 也提供了类似 logrus 的这种对应用法, 但是感觉有点另类. 需要配置文件设置<code>log.v</code> 配合 log.V(4).Info()使用. 如:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;xxx&#34;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>如果 <code>log.v</code> 设置是 5, 那么能打印<code>xxx</code>. 如果 <code>log.v</code> 小于 5, 则不能打印. 也就是说 log.V 只能打印比 log.v 小的日志</p>
<h4 id="logmodule">log.module<a hidden class="anchor" aria-hidden="true" href="#logmodule">#</a></h4>
<p>这个功能我觉得没啥用处. 具体的功能就是:</p>
<p>配置文件 <code>log.v</code> 设置是 3. 按照上面说的, log.V(5).Info(&ldquo;xx&rdquo;) 是肯定打印不出来的. 但是可以通过 <code>log.module</code> 来另外定义某些文件特殊打印级别</p>
<pre tabindex="0"><code>[log]
	v = 3
[log.module]
	&#34;dao_user&#34; = 5
	&#34;servic*&#34; = 1
</code></pre><p>在 dao_user.go 里面, log.V(5).Info(&ldquo;dao_user&rdquo;), 日志照样会打印 &ldquo;dao_user&rdquo;. <code>dao_user</code>, <code>servic*</code>是对应的文件的名字</p>
<h2 id="logstdout">log.stdout<a hidden class="anchor" aria-hidden="true" href="#logstdout">#</a></h2>
<p>这个简单, 就是控制日志是否打印在命令行里面. 生产环境需要关闭改选项(默认关闭), 在开发时打开这个是很有用的</p>
<h2 id="logdir">log.dir<a hidden class="anchor" aria-hidden="true" href="#logdir">#</a></h2>
<p>设置写日志文件的路径</p>
<h2 id="logfilter">log.filter<a hidden class="anchor" aria-hidden="true" href="#logfilter">#</a></h2>
<p>这个还是蛮有意思的功能. 比如打印日志的时候, <code>密码</code>等敏感信息一般是不能打印在日志文件里. 该功能就能将这些信息隐藏掉</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">log</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">filter</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;password&#34;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">log</span><span class="p">.</span><span class="nf">Infov</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">log</span><span class="p">.</span><span class="nf">KV</span><span class="p">(</span><span class="s">&#34;password&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;123456&#34;</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></div><p>打印出来就会变成<code>[2020/06/08 23:19:55.490] [INFO] [/demo1/cmd/main.go:21] password=***</code></p>
<p>整体上 kratos log 就提供了这么多功能, 下面进入源码分析</p>
<h2 id="源码分析">源码分析<a hidden class="anchor" aria-hidden="true" href="#源码分析">#</a></h2>
<h3 id="加载-init">加载 Init<a hidden class="anchor" aria-hidden="true" href="#加载-init">#</a></h3>
<p>其实加载没啥说的, 主要就是调用Init()函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span><span class="w"> </span><span class="nf">Init</span><span class="p">(</span><span class="nx">conf</span><span class="w"> </span><span class="o">*</span><span class="nx">Config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">var</span><span class="w"> </span><span class="nx">isNil</span><span class="w"> </span><span class="kt">bool</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">conf</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">isNil</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">conf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Config</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">Stdout</span><span class="p">:</span><span class="w"> </span><span class="nx">_stdout</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">Dir</span><span class="p">:</span><span class="w">    </span><span class="nx">_dir</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">V</span><span class="p">:</span><span class="w">      </span><span class="nb">int32</span><span class="p">(</span><span class="nx">_v</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">Module</span><span class="p">:</span><span class="w"> </span><span class="nx">_module</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">Filter</span><span class="p">:</span><span class="w"> </span><span class="nx">_filter</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">AppID</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Family</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">AppID</span><span class="w"> </span><span class="c1">// for caster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Host</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Hostname</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Host</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">host</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nf">Hostname</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Host</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">var</span><span class="w"> </span><span class="nx">hs</span><span class="w"> </span><span class="p">[]</span><span class="nx">Handler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="c1">// when env is dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">conf</span><span class="p">.</span><span class="nx">Stdout</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">isNil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">DeployEnv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">DeployEnv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">DeployEnvDev</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">_noagent</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">hs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">hs</span><span class="p">,</span><span class="w"> </span><span class="nf">NewStdout</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">conf</span><span class="p">.</span><span class="nx">Dir</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">hs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">hs</span><span class="p">,</span><span class="w"> </span><span class="nf">NewFile</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Dir</span><span class="p">,</span><span class="w"> </span><span class="nx">conf</span><span class="p">.</span><span class="nx">FileBufferSize</span><span class="p">,</span><span class="w"> </span><span class="nx">conf</span><span class="p">.</span><span class="nx">RotateSize</span><span class="p">,</span><span class="w"> </span><span class="nx">conf</span><span class="p">.</span><span class="nx">MaxLogFile</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">h</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nf">newHandlers</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Filter</span><span class="p">,</span><span class="w"> </span><span class="nx">hs</span><span class="o">...</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>作用:</p>
<ol>
<li>初始化文章一开头提到那五个功能: log.v, log.stdout, log.dir, log.module, log.filter</li>
<li>初始化 stdout, file handler</li>
</ol>
<h3 id="field">Field<a hidden class="anchor" aria-hidden="true" href="#field">#</a></h3>
<blockquote>
<p>基于zap的field方式实现的高性能log库，提供Info、Warn、Error日志级别；
并提供了context支持，方便打印环境信息以及日志的链路追踪，在框架中都通过field方式实现，避免format日志带来的性能消耗</p>
</blockquote>
<p>上面这段摘自官方wiki, 但是看完源码之后, 发现跟 zap 毛线关系没有, 就用了 zap 的一个结构体</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span><span class="w"> </span><span class="nx">Field</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">Key</span><span class="w">       </span><span class="kt">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">Value</span><span class="w">     </span><span class="kd">interface</span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">Type</span><span class="w">      </span><span class="nx">FieldType</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">StringVal</span><span class="w"> </span><span class="kt">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">Int64Val</span><span class="w">  </span><span class="kt">int64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>其实想不太明白, 就用了一个结构体(也没有用任何 zap 为该结构体提供的函数), 为何将 zap 那么多代码复制了过来, 差评</p>
<p>Kartos log 没有采用类似 logrus 或者 Zap json 或者 text 序列化的方案, 就以上面的 Field 为基础扩展一个 KVString, KVInt, &hellip;. KVDuration 结构. 在写日志时候, 我们就可以像下面这样打印多个kv</p>
<pre tabindex="0"><code>log.Infov(Context.TODO(), log.KVInt(&#34;key1&#34;, 100), log.KVString(&#34;key2&#34;, &#34;test value&#34;)
</code></pre><h3 id="handler">Handler<a hidden class="anchor" aria-hidden="true" href="#handler">#</a></h3>
<p>上面的log.InfoV(xxx) 将会调用下面的 Log() 函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">hs</span><span class="w"> </span><span class="nx">Handlers</span><span class="p">)</span><span class="w"> </span><span class="nf">Log</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">lv</span><span class="w"> </span><span class="nx">Level</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="o">...</span><span class="nx">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">hasSource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">hs</span><span class="p">.</span><span class="nx">filters</span><span class="p">[</span><span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Key</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#34;***&#34;</span><span class="w"> </span><span class="c1">// 实现log.filter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">_source</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">hasSource</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">hasSource</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">fn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">funcName</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nf">errIncr</span><span class="p">(</span><span class="nx">lv</span><span class="p">,</span><span class="w"> </span><span class="nx">fn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">d</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="w"> </span><span class="nf">KVString</span><span class="p">(</span><span class="nx">_source</span><span class="p">,</span><span class="w"> </span><span class="nx">fn</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">d</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span><span class="w"> </span><span class="nf">KV</span><span class="p">(</span><span class="nx">_time</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()),</span><span class="w"> </span><span class="nf">KVInt64</span><span class="p">(</span><span class="nx">_levelValue</span><span class="p">,</span><span class="w"> </span><span class="nb">int64</span><span class="p">(</span><span class="nx">lv</span><span class="p">)),</span><span class="w"> </span><span class="nf">KVString</span><span class="p">(</span><span class="nx">_level</span><span class="p">,</span><span class="w"> </span><span class="nx">lv</span><span class="p">.</span><span class="nf">String</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">h</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">hs</span><span class="p">.</span><span class="nx">handlers</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">h</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lv</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="o">...</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Kratos log 提供的所有Info(), Warn(), Error() 系列函数最终都会调用到这个函数上面来.</p>
<p>这个函数的主要作用就是:</p>
<ol>
<li>实现 log.filter 功能</li>
<li>增加一些额外的字段, 如: time, level, source Field</li>
<li>根据初始化 log 的时候是否启动 stdout 或者 file handler, 来调用对应的handler 的 Log 函数做最终处理</li>
</ol>
<h3 id="handlers-stdout-file">handlers (stdout, file)<a hidden class="anchor" aria-hidden="true" href="#handlers-stdout-file">#</a></h3>
<p>上面的Handler Log() 里面有这么句代码. 就是具体调用 stdout或者file handlers</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">h</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">hs</span><span class="p">.</span><span class="nx">handlers</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">h</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lv</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="o">...</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>不过在调用具体的 handler 来打印的时候, 需要对相关的 Field 来做处理, 分别会调用下面 toMap, addExtraField 函数, 将处理结果都放在一个 map[string]interface{}里</p>
<h4 id="tomap">toMap<a hidden class="anchor" aria-hidden="true" href="#tomap">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span><span class="w"> </span><span class="nf">toMap</span><span class="p">(</span><span class="nx">args</span><span class="w"> </span><span class="o">...</span><span class="nx">D</span><span class="p">)</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">d</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="mi">10</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">switch</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="nx">core</span><span class="p">.</span><span class="nx">UintType</span><span class="p">,</span><span class="w"> </span><span class="nx">core</span><span class="p">.</span><span class="nx">Uint64Type</span><span class="p">,</span><span class="w"> </span><span class="nx">core</span><span class="p">.</span><span class="nx">IntTpye</span><span class="p">,</span><span class="w"> </span><span class="nx">core</span><span class="p">.</span><span class="nx">Int64Type</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">d</span><span class="p">[</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">Int64Val</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="nx">core</span><span class="p">.</span><span class="nx">StringType</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">d</span><span class="p">[</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">StringVal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="nx">core</span><span class="p">.</span><span class="nx">Float32Type</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">d</span><span class="p">[</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">Float32frombits</span><span class="p">(</span><span class="nb">uint32</span><span class="p">(</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Int64Val</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="nx">core</span><span class="p">.</span><span class="nx">Float64Type</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">d</span><span class="p">[</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nf">Float64frombits</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Int64Val</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="nx">core</span><span class="p">.</span><span class="nx">DurationType</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">d</span><span class="p">[</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Int64Val</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="nx">d</span><span class="p">[</span><span class="nx">arg</span><span class="p">.</span><span class="nx">Key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">Value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>其实这段代码没啥意思, 就是将 KVInt(), KVString()系列函数对应的Val从对应的字段上取出来</p>
<h4 id="addextrafield">addExtraField<a hidden class="anchor" aria-hidden="true" href="#addextrafield">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span><span class="w"> </span><span class="nf">addExtraField</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">fields</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">trace</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_tid</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nf">TraceID</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">caller</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span><span class="nx">Caller</span><span class="p">);</span><span class="w"> </span><span class="nx">caller</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_caller</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">caller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span><span class="nx">Color</span><span class="p">);</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_color</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Color</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_envColor</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">);</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_cluster</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_deplyEnv</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">DeployEnv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_zone</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">Zone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_appID</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Family</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_instanceID</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span><span class="nx">Mirror</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nx">fields</span><span class="p">[</span><span class="nx">_mirror</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这段代码就是另外再加几个字段, 如果 env, zone, appid, instance_id, caller, tid</p>
<h3 id="pattern">Pattern<a hidden class="anchor" aria-hidden="true" href="#pattern">#</a></h3>
<p>经过上面的操作基本上操作, map[string]interface{} 里面大概有这些内容</p>
<pre tabindex="0"><code>test1 -&gt; test1
source -&gt; /learn_kratos/demo1/cmd/main.go:21
time -&gt; 2020-06-09T19:07:36.3063
level_value -&gt; 1
level -&gt; INFO
app_id -&gt; xxx-service
instance_id -&gt; localhost
env -&gt; dev
zone -&gt; zone01
</code></pre><p>接着要做的就是将他们写成字符串(对, kratos 只提供了TextFormater方式)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span><span class="w"> </span><span class="nx">patternMap</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kt">string</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;T&#34;</span><span class="p">:</span><span class="w"> </span><span class="nx">longTime</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;t&#34;</span><span class="p">:</span><span class="w"> </span><span class="nx">shortTime</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;D&#34;</span><span class="p">:</span><span class="w"> </span><span class="nx">longDate</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;d&#34;</span><span class="p">:</span><span class="w"> </span><span class="nx">shortDate</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;L&#34;</span><span class="p">:</span><span class="w"> </span><span class="nf">keyFactory</span><span class="p">(</span><span class="nx">_level</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;f&#34;</span><span class="p">:</span><span class="w"> </span><span class="nf">keyFactory</span><span class="p">(</span><span class="nx">_source</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;i&#34;</span><span class="p">:</span><span class="w"> </span><span class="nf">keyFactory</span><span class="p">(</span><span class="nx">_instanceID</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;e&#34;</span><span class="p">:</span><span class="w"> </span><span class="nf">keyFactory</span><span class="p">(</span><span class="nx">_deplyEnv</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;z&#34;</span><span class="p">:</span><span class="w"> </span><span class="nf">keyFactory</span><span class="p">(</span><span class="nx">_zone</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;S&#34;</span><span class="p">:</span><span class="w"> </span><span class="nx">longSource</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;s&#34;</span><span class="p">:</span><span class="w"> </span><span class="nx">shortSource</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s">&#34;M&#34;</span><span class="p">:</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">...</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">funcs</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nx">builder</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nf">f</span><span class="p">(</span><span class="nx">d</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这里的实现方式还是蛮巧妙的, 可以看看</p>
<h3 id="stdout-filewriter">stdout, filewriter<a hidden class="anchor" aria-hidden="true" href="#stdout-filewriter">#</a></h3>
<p>经过上面的处理, 就进入了最后的输出阶段了, 分别对应 stdout, filewirter</p>
<p>鉴于篇幅有限, filewriter 本篇就不再介绍, 另外再出一篇吧</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>优点: kratos log整体采用 Kv 结构来处理, 结构比较清晰, 功能简单, 没有序列化的压力, 追踪日志需要的字段全都有.</p>
<p>缺点: 只支持TextFormater, 日志级别控制跟当前主流 Log 框架使用习惯不太一样</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://georgehao.github.io/tags/golang/">Golang</a></li>
      <li><a href="https://georgehao.github.io/tags/kratos/">Kratos</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://georgehao.github.io/posts/2020-06-27-leaky-bucket/">
    <span class="title">« 上一页</span>
    <br>
    <span>限流器系列(1) -- Leaky Bucket 漏斗桶</span>
  </a>
  <a class="next" href="https://georgehao.github.io/posts/2020-05-22-kratos-fanout/">
    <span class="title">下一页 »</span>
    <br>
    <span>Bilibili Kratos 框架源码分析(3) -- fanout异步</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bilibili Kratos 框架源码分析(4) -- Kratos Log on x"
            href="https://x.com/intent/tweet/?text=Bilibili%20Kratos%20%e6%a1%86%e6%9e%b6%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%284%29%20--%20Kratos%20Log&amp;url=https%3a%2f%2fgeorgehao.github.io%2fposts%2f2020-06-09-kratos-log%2f&amp;hashtags=golang%2ckratos">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bilibili Kratos 框架源码分析(4) -- Kratos Log on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgeorgehao.github.io%2fposts%2f2020-06-09-kratos-log%2f&amp;title=Bilibili%20Kratos%20%e6%a1%86%e6%9e%b6%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%284%29%20--%20Kratos%20Log&amp;summary=Bilibili%20Kratos%20%e6%a1%86%e6%9e%b6%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%284%29%20--%20Kratos%20Log&amp;source=https%3a%2f%2fgeorgehao.github.io%2fposts%2f2020-06-09-kratos-log%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bilibili Kratos 框架源码分析(4) -- Kratos Log on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fgeorgehao.github.io%2fposts%2f2020-06-09-kratos-log%2f&title=Bilibili%20Kratos%20%e6%a1%86%e6%9e%b6%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%284%29%20--%20Kratos%20Log">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bilibili Kratos 框架源码分析(4) -- Kratos Log on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgeorgehao.github.io%2fposts%2f2020-06-09-kratos-log%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bilibili Kratos 框架源码分析(4) -- Kratos Log on whatsapp"
            href="https://api.whatsapp.com/send?text=Bilibili%20Kratos%20%e6%a1%86%e6%9e%b6%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%284%29%20--%20Kratos%20Log%20-%20https%3a%2f%2fgeorgehao.github.io%2fposts%2f2020-06-09-kratos-log%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bilibili Kratos 框架源码分析(4) -- Kratos Log on telegram"
            href="https://telegram.me/share/url?text=Bilibili%20Kratos%20%e6%a1%86%e6%9e%b6%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%284%29%20--%20Kratos%20Log&amp;url=https%3a%2f%2fgeorgehao.github.io%2fposts%2f2020-06-09-kratos-log%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bilibili Kratos 框架源码分析(4) -- Kratos Log on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Bilibili%20Kratos%20%e6%a1%86%e6%9e%b6%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%284%29%20--%20Kratos%20Log&u=https%3a%2f%2fgeorgehao.github.io%2fposts%2f2020-06-09-kratos-log%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© 2021 <a href="https://georgehao.github.io/">haohongfan</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
